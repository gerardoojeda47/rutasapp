name: Build and Release APK

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          cache: true

      - name: Setup Android SDK and Tools
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0
          ndk-version: 25.1.8937393

      - name: Accept Android Licenses
        run: flutter doctor --android-licenses

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Advanced Dependency Resolution
        run: |
          # Clean everything
          flutter clean
          rm -rf ~/.pub-cache/hosted/pub.dev/geolocator_android-*

          # Force refresh dependencies
          flutter pub cache repair
          flutter pub get --verbose

          # Verify critical dependencies
          flutter pub deps | grep -E "(geolocator|flutter_map|latlong2)"

      - name: Pre-build Validation
        run: |
          # Validate Flutter installation
          flutter doctor -v

          # Check for common issues
          flutter analyze --no-fatal-infos

          # Validate Android configuration
          ls -la android/app/build.gradle.kts
          cat android/app/build.gradle.kts | grep -E "(compileSdk|targetSdk|ndkVersion)"

      - name: Build APK Release
        run: |
          echo "ğŸ—ï¸ Building APK release..."
          flutter build apk --release --verbose
          echo "âœ… APK built successfully!"
          ls -la build/app/outputs/flutter-apk/

      - name: Alternative Build Strategy (if main fails)
        if: failure()
        run: |
          echo "ğŸ”„ Main build failed, trying alternative approach..."
          flutter clean
          flutter pub get
          flutter build apk --release --no-tree-shake-icons --verbose

      - name: Advanced APK Verification and Health Check
        run: |
          echo "ğŸ” Performing comprehensive APK verification..."

          # Check if APK exists
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ… APK file found"
            
            # Get APK details
            ls -lah build/app/outputs/flutter-apk/app-release.apk
            file build/app/outputs/flutter-apk/app-release.apk
            
            # Check APK size (should be reasonable)
            APK_SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
            echo "ğŸ“¦ APK Size: $((APK_SIZE / 1024 / 1024)) MB"
            
            if [ $APK_SIZE -gt 10485760 ]; then  # > 10MB
              echo "âœ… APK size is reasonable"
            else
              echo "âš ï¸ APK size seems too small, might be corrupted"
            fi
            
            # Verify APK structure
            unzip -l build/app/outputs/flutter-apk/app-release.apk | head -20
            
          else
            echo "âŒ APK file not found, listing directory contents:"
            find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            ls -la build/app/outputs/ 2>/dev/null || echo "Output directory not found"
            exit 1
          fi

      - name: Rename APK for release
        run: |
          mkdir -p release
          cp build/app/outputs/flutter-apk/app-release.apk release/RouWhite-v${{ github.run_number }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: RouWhite v${{ github.run_number }}
          body: |
            ğŸš€ **Nueva versiÃ³n de RouWhite disponible!**

            ğŸ“± **Descarga:** https://gerardoojeda47.github.io/rutasapp/
            ğŸ“… **Fecha:** ${{ github.event.head_commit.timestamp }}
            ğŸ”¢ **VersiÃ³n:** v${{ github.run_number }}
            ğŸ“¦ **Tipo:** Debug APK (para testing)
            ğŸ”§ **Commit:** ${{ github.sha }}

            ## ğŸ“² InstalaciÃ³n:
            1. Descarga el APK desde los assets de esta release
            2. Habilita "Fuentes desconocidas" en Android
            3. Instala la aplicaciÃ³n

            ## ğŸ—ºï¸ CaracterÃ­sticas:
            - Rutas de transporte pÃºblico en PopayÃ¡n
            - Mapas interactivos con flutter_map 8.1.0
            - InformaciÃ³n de paradas en tiempo real
            - NavegaciÃ³n GPS mejorada
            - Compatibilidad con Android SDK 36

            ## ğŸ”§ Correcciones en esta versiÃ³n:
            - âœ… Errores de compilaciÃ³n corregidos
            - âœ… Dependencias actualizadas y compatibles
            - âœ… API de geolocator actualizada
            - âœ… Problemas de const LatLng resueltos
          files: |
            release/RouWhite-v${{ github.run_number }}.apk
          draft: false
          prerelease: false
